{% extends "base.html" %}
{% block title %}Xác thực hai lớp (2FA){% endblock %}

{% block content %}
<div class="glass-card">

    <div class="card-header">Xác thực hai lớp (2FA)</div>

    {% if is_enabled %}
        <div class="card-desc">
            ✔ 2FA đã bật cho tài khoản <strong>{{ request.user.username }}</strong>.<br>
            Tài khoản của bạn đang được bảo vệ bằng OTP 6 số thay đổi mỗi 30 giây.
        </div>

        <div class="form-hint" style="margin-bottom:16px;">
            Nếu bạn mất điện thoại, admin có thể reset secret OTP cho bạn trong trang quản trị.
        </div>

        <div style="text-align:right;">
            <a class="btn-primary" href="{% url 'accounts:dashboard' %}">Quay lại dashboard</a>
        </div>

    {% else %}
        <div class="card-desc">
            Quét mã QR bên dưới bằng Google Authenticator (hoặc app Authenticator khác),
            sau đó nhập mã OTP 6 số để kích hoạt bảo vệ 2 lớp cho tài khoản.
        </div>

        {% if qr_b64 %}
            <div style="text-align:center; margin-bottom:16px;">
                <img src="data:image/png;base64,{{ qr_b64 }}" alt="QR Code 2FA"
                    style="width:160px; height:160px; border-radius:12px;
                           border:1px solid rgba(255,255,255,0.2);
                           box-shadow:0 20px 40px rgba(0,0,0,0.8);">

                <div class="form-hint" style="margin-top:8px; word-break:break-all;">
                    {{ otp_uri }}
                </div>
            </div>
        {% endif %}

        {% if show_form %}
            <form method="post" action="{% url 'accounts:enable_2fa' %}">
                {% csrf_token %}

                <div class="form-group">
                    <label class="form-label" for="id_otp_code">Mã OTP 6 số</label>
                    <input class="form-input"
                           type="text"
                           name="otp_code"
                           id="id_otp_code"
                           placeholder="123456"
                           required>
                    <div class="form-hint">Mã thay đổi mỗi 30 giây</div>
                </div>

                {% if messages %}
                    {% for m in messages %}
                        <div class="form-error">{{ m }}</div>
                    {% endfor %}
                {% endif %}

                <div class="form-group" style="text-align:right;">
                    <button class="btn-primary" type="submit">Kích hoạt 2FA</button>
                </div>
            </form>
        {% endif %}

        <div class="form-hint">
            Sau khi kích hoạt thành công, bạn sẽ cần nhập OTP sau bước mật khẩu khi đăng nhập.
        </div>
    {% endif %}
</div>
{% endblock %}
