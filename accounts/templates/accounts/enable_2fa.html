{% extends "base.html" %}

{% block title %}Thiết lập Bảo mật 2 lớp{% endblock %}

{% block content %}
<style>
    /* Custom CSS cho trang 2FA */
    .twofa-container {
        max-width: 900px;
        margin: 2rem auto;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        overflow: hidden;
        display: flex;
        flex-wrap: wrap;
    }

    .twofa-guide {
        flex: 1;
        min-width: 300px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 3rem;
        border-right: 1px solid #dee2e6;
    }

    .twofa-action {
        flex: 1.2;
        min-width: 350px;
        padding: 3rem;
        background: #fff;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .step-item {
        margin-bottom: 2rem;
        position: relative;
        padding-left: 20px;
    }
    .step-item:before {
        content: '';
        position: absolute;
        left: 0;
        top: 5px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #0d6efd;
    }
    .step-title {
        font-weight: 700;
        color: #212529;
        margin-bottom: 0.5rem;
        display: block;
    }
    .app-badges img {
        height: 40px;
        margin-right: 10px;
        margin-top: 10px;
        border-radius: 5px;
        border: 1px solid #ddd;
    }

    .qr-wrapper {
        padding: 15px;
        border: 2px dashed #0d6efd;
        border-radius: 12px;
        background: #fff;
        margin-bottom: 1.5rem;
        transition: transform 0.3s ease;
    }
    .qr-wrapper:hover {
        transform: scale(1.02);
        border-style: solid;
    }
    .qr-wrapper img {
        display: block;
        max-width: 100%;
        height: auto;
    }

    .otp-input-wrapper input {
        letter-spacing: 0.5em;
        text-align: center;
        font-size: 1.5rem;
        font-weight: 700;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 0.75rem;
        width: 100%;
        transition: border-color 0.3s;
        text-transform: uppercase;
        color: #212529;
        background-color: #fff;
    }
    .otp-input-wrapper input:focus {
        border-color: #0d6efd;
        outline: none;
        box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.1);
    }

    .secret-key-box {
        background: #f1f3f5;
        padding: 10px 15px;
        border-radius: 6px;
        font-family: monospace;
        font-size: 0.9rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1rem;
        border: 1px solid #e9ecef;
        width: 100%;
    }
    .copy-btn {
        background: none;
        border: none;
        color: #0d6efd;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.8rem;
    }
    .copy-btn:hover { text-decoration: underline; }

    @media (max-width: 768px) {
        .twofa-guide { border-right: none; border-bottom: 1px solid #dee2e6; }
    }
</style>

<div class="twofa-container">
    <div class="twofa-guide">
        <h2 class="mb-4" style="font-weight: 800; color: #0d6efd;">
            <i class="fas fa-shield-alt"></i> Bảo mật 2 lớp
        </h2>
        <p class="text-muted mb-4">
            Bảo vệ tài khoản của bạn bằng cách yêu cầu mã xác thực từ điện thoại mỗi khi đăng nhập.
        </p>

        <div class="step-item">
            <span class="step-title">Bước 1: Tải ứng dụng</span>
            <span class="text-muted small">Tải Google Authenticator hoặc Microsoft Authenticator về điện thoại.</span>
            <div class="app-badges">
                <a href="https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2" target="_blank">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/7/78/Google_Play_Store_badge_EN.svg" alt="Google Play">
                </a>
                <a href="https://apps.apple.com/us/app/google-authenticator/id388497605" target="_blank">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/3/3c/Download_on_the_App_Store_Badge.svg" alt="App Store">
                </a>
            </div>
        </div>

        <div class="step-item">
            <span class="step-title">Bước 2: Quét mã QR</span>
            <span class="text-muted small">Mở app, chọn dấu (+) và chọn "Quét mã QR".</span>
        </div>

        <div class="step-item">
            <span class="step-title">Bước 3: Nhập mã xác nhận</span>
            <span class="text-muted small">Nhập mã từ ứng dụng vào ô bên cạnh để kích hoạt.</span>
        </div>
        
        
    </div>

    <div class="twofa-action">
        <div class="qr-wrapper">
            <img src="data:image/png;base64,{{ qr_b64 }}" alt="QR Code">
        </div>
        
        <p class="text-center small text-muted mb-3">Không quét được mã?</p>
        
        <div class="secret-key-box" title="Mã bí mật">
            <span id="secretKeyText">{{ secret_key }}</span>
            <button type="button" class="copy-btn" onclick="copySecret()">COPY</button>
        </div>

        <hr class="w-100 my-4">

        <form method="post" class="w-100">
            {% csrf_token %}
            
            <div class="mb-3">
                <label class="form-label fw-bold small text-uppercase text-muted">Nhập mã</label>
                <div class="otp-input-wrapper">
                    <input type="text" name="otp_code" id="id_otp_code" required autocomplete="off">
                </div>
                {% if form.otp_code.errors %}
                    <div class="text-danger small mt-2 text-center">
                        {{ form.otp_code.errors.0 }}
                    </div>
                {% endif %}
            </div>

            <button type="submit" class="btn btn-primary w-100 py-3 fw-bold shadow-sm">
                KÍCH HOẠT BẢO MẬT NGAY
            </button>
        </form>
    </div>
</div>

<script>
    function copySecret() {
        var copyText = document.getElementById("secretKeyText");
        navigator.clipboard.writeText(copyText.innerText).then(function() {
            var btn = document.querySelector('.copy-btn');
            btn.innerText = "ĐÃ COPY!";
            setTimeout(() => { btn.innerText = "COPY"; }, 2000);
        });
    }

    document.addEventListener("DOMContentLoaded", function() {
        var input = document.getElementById('id_otp_code');
        if(input) input.focus();
    });
</script>

{% endblock %}